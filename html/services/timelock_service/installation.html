<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Timelock Server Installation &mdash; OSS AtlasDB develop documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/release-notes.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Migration to Timelock Server" href="migration.html" />
    <link rel="prev" title="External Timelock Service" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> OSS AtlasDB
          </a>
              <div class="version">
                develop
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../schemas/index.html">Schemas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../transactions/index.html">Transactions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/index.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cluster_management/index.html">Cluster Management</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Services</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../key_value_services/index.html">Key Value Services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../lock_service/index.html">Lock Service</a></li>
<li class="toctree-l2"><a class="reference internal" href="../timestamp_service/index.html">Timestamp Service</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">External Timelock Service</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Timelock Server Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="migration.html">Migration to Timelock Server</a></li>
<li class="toctree-l3"><a class="reference internal" href="manual-migration.html">Manual Migration to Timelock Server</a></li>
<li class="toctree-l3"><a class="reference internal" href="reverse-migration.html">Reverse Migration</a></li>
<li class="toctree-l3"><a class="reference internal" href="product-changes.html">Developing a product to use the timelock service</a></li>
<li class="toctree-l3"><a class="reference internal" href="paxos.html">Paxos and AtlasDB</a></li>
<li class="toctree-l3"><a class="reference internal" href="service-management.html">Service Management</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../performance/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../miscellaneous/index.html">Miscellaneous</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting/index.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes/index.html">Releases</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">OSS AtlasDB</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Services</a> &raquo;</li>
          <li><a href="index.html">External Timelock Service</a> &raquo;</li>
      <li>Timelock Server Installation</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/palantir/atlasdb/blob/develop/docs/source/services/timelock_service/installation.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="timelock-server-installation">
<span id="timelock-installation"></span><h1>Timelock Server Installation<a class="headerlink" href="#timelock-server-installation" title="Permalink to this headline">¶</a></h1>
<p>This guide explains how to install the Timelock server, and to configure existing services to use Timelock Server rather than embedded AtlasDB time and lock services.
The basic method is to first install Timelock without any clients, and then for each existing service, prepare the service and Timelock to talk to each other.</p>
<div class="section" id="obtain-the-timelock-binaries">
<h2>Obtain the Timelock binaries<a class="headerlink" href="#obtain-the-timelock-binaries" title="Permalink to this headline">¶</a></h2>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Internal consumers can skip these steps.</p>
</div>
<ol class="arabic">
<li><p class="first">Clone the git repository.</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">git</span><span class="nd">@github</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="n">palantir</span><span class="o">/</span><span class="n">atlasdb</span><span class="o">.</span><span class="n">git</span><span class="p">;</span> <span class="n">cd</span> <span class="n">atlasdb</span>
</pre></div>
</div>
</li>
<li><p class="first">Generate a tar file with Gradle:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">gradlew</span> <span class="n">timelock</span><span class="o">-</span><span class="n">server</span><span class="p">:</span><span class="n">distTar</span>
</pre></div>
</div>
</li>
</ol>
<blockquote>
<div>This will place a tar file in the <code class="docutils literal notranslate"><span class="pre">build/distributions</span></code> directory of the <code class="docutils literal notranslate"><span class="pre">timelock-server</span></code> project. The
tar file follows semantic versioning.</div></blockquote>
</div>
<div class="section" id="install-timelock-without-clients">
<h2>Install Timelock (without clients)<a class="headerlink" href="#install-timelock-without-clients" title="Permalink to this headline">¶</a></h2>
<p>We recommend deploying either a 3-node or a 5-node Timelock cluster.
A 3-node cluster will provide better performance, whereas a 5-node cluster has greater fault tolerance.</p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">Internal consumers can deploy the binaries by the usual method.</p>
</div>
<p>For real-world installations, we recommend provisioning a dedicated host machine for each Timelock server.</p>
<ol class="arabic" start="3">
<li><p class="first">Copy this tar file to each machine on which you want to deploy Timelock Server.</p>
</li>
<li><p class="first">On each machine which you intend to deploy Timelock Server, untar the archive.</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tar</span> <span class="o">-</span><span class="n">zxvf</span> <span class="n">timelock</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="mf">0.25</span><span class="o">.</span><span class="mf">0.</span><span class="n">sls</span><span class="o">.</span><span class="n">tgz</span><span class="p">;</span> <span class="n">cd</span> <span class="n">timelock</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="mf">0.25</span><span class="o">.</span><span class="mi">0</span>
</pre></div>
</div>
</li>
<li><p class="first">Configure the Timelock Server - see <a class="reference internal" href="../../configuration/external_timelock_service_configs/timelock_server_config.html#timelock-server-configuration"><span class="std std-ref">Timelock Server Configuration</span></a> for a guide on this. The configuration file
is at <code class="docutils literal notranslate"><span class="pre">var/conf/timelock.yml</span></code> relative to the root directory of the Timelock Server.</p>
</li>
<li><p class="first">Start the Timelock Server with <code class="docutils literal notranslate"><span class="pre">service/bin/init.sh</span> <span class="pre">start</span></code>.
This should output the process ID of the Timelock Server. You can view the logs in the (by default) <code class="docutils literal notranslate"><span class="pre">var/log</span></code>
directory.</p>
</li>
<li><p class="first">It may be useful to run a health-check to verify that the Timelock Server is running. To do this, you can curl
the server’s <code class="docutils literal notranslate"><span class="pre">healthcheck</span></code> endpoint on its admin port (default: 8081).</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">8081</span><span class="o">/</span><span class="n">healthcheck</span>
</pre></div>
</div>
<p>The output should indicate that the Timelock Server is healthy. The output should resemble the following:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;deadlocks&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;healthy&quot;</span><span class="p">:</span> <span class="n">true</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="add-client-s-to-timelock">
<h2>Add client(s) to Timelock<a class="headerlink" href="#add-client-s-to-timelock" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple" start="8">
<li>Back up each client, following the steps declared in <a class="reference internal" href="../../cluster_management/backup-restore.html#backup-restore"><span class="std std-ref">Backup and Restore</span></a>.</li>
<li>Configure each client to use Timelock.
Detailed documentation is <a class="reference internal" href="../../configuration/external_timelock_service_configs/timelock_client_config.html#timelock-client-configuration"><span class="std std-ref">here</span></a>.
You must remove any <code class="docutils literal notranslate"><span class="pre">leader</span></code>, <code class="docutils literal notranslate"><span class="pre">timestamp</span></code>, or <code class="docutils literal notranslate"><span class="pre">lock</span></code> blocks; the <code class="docutils literal notranslate"><span class="pre">timelock</span></code> block to add looks like this:</li>
</ol>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">atlasdb</span><span class="p">:</span>
   <span class="nt">timelock</span><span class="p">:</span>
     <span class="nt">serversList</span><span class="p">:</span>
       <span class="nt">servers</span><span class="p">:</span>
         <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">palantir-1.com:8080</span>
         <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">palantir-2.com:8080</span>
         <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">palantir-3.com:8080</span>
       <span class="nt">sslConfiguration</span><span class="p">:</span>
         <span class="nt">trustStorePath</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">var/security/truststore.jks</span>
</pre></div>
</div>
<ol class="arabic simple" start="10">
<li>(Optional) For verification purposes, you may retrieve a timestamp from each client you are configuring to use TimeLock.
This can typically be performed with the Fetch Timestamp CLI or Dropwizard bundle. For example, using the Dropwizard bundle:</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./service/bin/&lt;service&gt; atlasdb timestamp fetch

 Note down the value of the timestamp returned<span class="p">;</span> we will subsequently use these values to ensure that migration took place.
</pre></div>
</div>
<ol class="arabic simple" start="11">
<li>Shut down each client that has been newly added.</li>
<li>Restart your Timelock cluster.</li>
<li>Migrate each client to the timelock server - see the <a class="reference internal" href="migration.html#timelock-migration"><span class="std std-ref">separate migration docs</span></a>. For Cassandra KVS, this is automatic.</li>
</ol>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Do not skip this step if your client uses DbKvs! Failure to migrate your client will cause <strong>severe data corruption</strong>, as Timelock will serve timestamps starting from 1.</p>
</div>
<ol class="arabic simple" start="14">
<li>Restart each client.</li>
<li>(Optional) To verify that the migration worked correctly, get a fresh timestamp for each client from the Timelock server.
For each client, the timestamp returned should be strictly greater than the corresponding timestamp obtained in step 10.</li>
</ol>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="External Timelock Service" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="migration.html" class="btn btn-neutral float-right" title="Migration to Timelock Server" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, Palantir Technologies.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>