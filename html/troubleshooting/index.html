

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Troubleshooting &mdash; OSS AtlasDB develop documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/release-notes.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Releases" href="../release_notes/index.html" />
    <link rel="prev" title="AtlasDB Metrics" href="../miscellaneous/dropwizard-metrics.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> OSS AtlasDB
          

          
          </a>

          
            
            
              <div class="version">
                develop
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../schemas/index.html">Schemas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../transactions/index.html">Transactions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../configuration/index.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cluster_management/index.html">Cluster Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/index.html">Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../performance/index.html">Performance Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../miscellaneous/index.html">Miscellaneous</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../release_notes/index.html">Releases</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">OSS AtlasDB</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Troubleshooting</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/palantir/atlasdb/blob/develop/docs/source/troubleshooting/index.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="troubleshooting">
<span id="id1"></span><h1>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#clearing-the-schema-mutation-lock" id="id3">Clearing the schema mutation lock</a><ul>
<li><a class="reference internal" href="#clear-with-cli" id="id4">Clear with CLI</a></li>
<li><a class="reference internal" href="#clear-with-cql" id="id5">Clear with CQL</a></li>
</ul>
</li>
<li><a class="reference internal" href="#clearing-the-backup-lock" id="id6">Clearing the Backup Lock</a><ul>
<li><a class="reference internal" href="#clear-with-curl" id="id7">Clear with cURL</a></li>
<li><a class="reference internal" href="#id2" id="id8">Clear with CQL</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="clearing-the-schema-mutation-lock">
<span id="clearing-schema-mutation-lock"></span><h2><a class="toc-backref" href="#id3">Clearing the schema mutation lock</a><a class="headerlink" href="#clearing-the-schema-mutation-lock" title="Permalink to this headline">¶</a></h2>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">The schema mutation lock is no longer used from Atlas 0.108.0 onwards.
These steps are maintained here for reference for users of AtlasDB on older versions.</p>
</div>
<p>In versions of AtlasDB prior to 0.108.0, we hold a <a class="reference internal" href="../schemas/migrating_schemas.html#schema-mutation-lock"><span class="std std-ref">schema mutation lock</span></a> while performing schema mutations (e.g. creating or dropping tables) in Cassandra.
If an AtlasDB client dies while holding the lock, the lock must be manually cleared or clients will not be able to perform schema mutations.
Prior to AtlasDB 0.19, we would always grab the schema mutation lock on startup, and thus would fail to start until the lock had been cleared.</p>
<p>You will see one or both of the following exceptions when the schema mutation lock has been dropped:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>// TimeoutException

We have timed out waiting on the current schema mutation lock holder. We have
tried to grab the lock for %d milliseconds unsuccessfully. This indicates
that the current lock holder has died without releasing the lock and will
require manual intervention. Shut down all AtlasDB clients operating on the
%s keyspace and then run the clean-cass-locks-state cli command.
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>// RuntimeException

The current lock holder has failed to update its heartbeat. We suspect that this
might be due to a node crashing while holding the schema mutation lock. If this
is indeed the case, run the clean-cass-locks-state cli command.
</pre></div>
</div>
<div class="section" id="clear-with-cli">
<h3><a class="toc-backref" href="#id4">Clear with CLI</a><a class="headerlink" href="#clear-with-cli" title="Permalink to this headline">¶</a></h3>
<p>One runs the CLIs as a separate distribution. These distributions are published on
<a class="reference external" href="https://palantir.bintray.com/releases/com/palantir/atlasdb/atlasdb-cli-distribution/0.78.0/">Bintray</a> - please make
sure to use the corresponding version of the CLIs with your service. The command can then be invoked as</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./service/bin/atlasdb-cli --offline -c var/conf/&lt;service&gt;.yml clean-cass-locks-state
</pre></div>
</div>
</div>
<div class="section" id="clear-with-cql">
<h3><a class="toc-backref" href="#id5">Clear with CQL</a><a class="headerlink" href="#clear-with-cql" title="Permalink to this headline">¶</a></h3>
<p>If you prefer to clear the lock with the Cassandra Query Language (CQL), then you can run commands similar to the below.
Note that on more recent versions of AtlasDB, the <code class="docutils literal notranslate"><span class="pre">_locks</span></code> table will have a hexadecimal string suffix; however, the
truncation process remains similar.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cd my/cassandra/service/dir
./bin/cqlsh
cqlsh&gt; use &quot;myKeyspace&quot;;
cqlsh:myKeyspace&gt; describe tables;

&quot;myKeyspace__table1&quot;
&quot;_locks&quot;
&quot;myKeyspace__table2&quot;
&quot;_timestamp&quot;
&quot;myKeyspace__table3&quot;
&quot;_transactions&quot;
sweep__priority
&quot;_scrub&quot;
&quot;_punch&quot;
&quot;_metadata&quot;
sweep__progress

cqlsh:myKeyspace&gt; select * from &quot;_locks&quot;;

 key                              | column1                    | column2 | value
----------------------------------+----------------------------+---------+--------------------
 0x476c6f62616c2044444c206c6f636b | 0x69645f776974685f6c6f636b |      -1 | 0x11884a8da443f45a

(1 rows)
cqlsh:myKeyspace&gt; truncate table &quot;_locks&quot;;
cqlsh:myKeyspace&gt; select * from &quot;_locks&quot;;

 key | column1 | column2 | value
-----+---------+---------+-------

(0 rows)
cqlsh:myKeyspace&gt;
</pre></div>
</div>
<p>You should now be able to successfully start your services.</p>
</div>
</div>
<div class="section" id="clearing-the-backup-lock">
<span id="clearing-persistent-lock"></span><h2><a class="toc-backref" href="#id6">Clearing the Backup Lock</a><a class="headerlink" href="#clearing-the-backup-lock" title="Permalink to this headline">¶</a></h2>
<p>If the background sweeper or an automated backup process dies at the wrong point (i.e. while holding the backup lock), future sweep/backup processes will not complete, because the lock will have been taken.
If this happens, then you should follow these remediation steps:</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This process should only be attempted if you are sure that the process has died, being aware that it may be running on another machine.
Releasing the lock of a running process would invalidate the consistency guarantees of any backups that are started while that process is still running!</p>
</div>
<div class="section" id="clear-with-curl">
<h3><a class="toc-backref" href="#id7">Clear with cURL</a><a class="headerlink" href="#clear-with-curl" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>Find the currently-held lock, by examining the logs. Attempting to acquire a lock will cause the currently held lock to be logged:</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>INFO  <span class="o">[</span><span class="m">2017</span>-02-01 <span class="m">16</span>:40:34,333<span class="o">]</span> com.palantir.atlasdb.persistentlock.CheckAndSetExceptionMapper: Request failed.
  Stored persistent lock: LockEntry<span class="o">{</span><span class="nv">lockName</span><span class="o">=</span>BackupLock, <span class="nv">instanceId</span><span class="o">=</span>427eb02a-f017-40cd-8d08-0a163315029a, <span class="nv">reason</span><span class="o">=</span>manual-backup<span class="o">}</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li>Curl the <code class="docutils literal notranslate"><span class="pre">release</span></code> endpoint. Note that the required formatting is slightly different (keys and values must be surrounded with <code class="docutils literal notranslate"><span class="pre">&quot;</span></code>).</li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ curl -X POST --header <span class="s1">&#39;content-type: application/json&#39;</span> <span class="s1">&#39;&lt;product-base-url&gt;/persistent-lock/release-backup-lock&#39;</span> -d <span class="s1">&#39;&quot;427eb02a-f017-40cd-8d08-0a163315029a&quot;&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3><a class="toc-backref" href="#id8">Clear with CQL</a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The Backup Lock is serialised differently than the Schema Mutation Lock. In particular, truncating the persisted
locks table will <strong>not</strong> release the Backup Lock, and will in fact put your cluster in a bad (though recoverable)
state!</p>
</div>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">The steps below are Cassandra-specific, but the serialisation mechanics we use for other key-value services are very
similar. You will want to restore the relevant cell in your key-value service to the value documented below.</p>
</div>
<p>If you are unable to find the currently-held lock in the logs, this approach may be helpful.
The state of persisted locks is stored in the <code class="docutils literal notranslate"><span class="pre">_persisted_locks</span></code> table in your AtlasDB keyspace; specifically, the
state of the backup lock is stored in a cell with row name <code class="docutils literal notranslate"><span class="pre">BackupLock</span></code> and column name <code class="docutils literal notranslate"><span class="pre">lock</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cqlsh&gt; USE keyspace;
cqlsh:keyspace&gt; SELECT * FROM &quot;_persisted_locks&quot;;

 key                    | column1    | column2 | value
------------------------+------------+---------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 0x4261636b75704c6f636b | 0x6c6f636b |      -1 | 0x7b226c6f636b4e616d65223a224261636b75704c6f636b222c22696e7374616e63654964223a2234323765623032612d663031372d343063642d386430382d306131363333313530323961222c22726561736f6e223a22666f6f227d
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">value</span></code> stored here is a serialised representation of the JSON <code class="docutils literal notranslate"><span class="pre">LockEntry</span></code>; that included in the table above
actually deserialises to</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>&#39;{&quot;lockName&quot;:&quot;BackupLock&quot;,&quot;instanceId&quot;:&quot;427eb02a-f017-40cd-8d08-0a163315029a&quot;,&quot;reason&quot;:&quot;foo&quot;}&#39;
</pre></div>
</div>
<p>AtlasDB interprets a specific <code class="docutils literal notranslate"><span class="pre">LockEntry</span></code> value as meaning that the lock is available:</p>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// &#39;{&quot;lockName&quot;:&quot;BackupLock&quot;,&quot;instanceId&quot;:&quot;00000000-0000-0000-0000-000000000000&quot;,&quot;reason&quot;:&quot;Available&quot;}&#39;</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">LockEntry</span> <span class="n">LOCK_OPEN</span> <span class="o">=</span> <span class="n">ImmutableLockEntry</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
            <span class="p">.</span><span class="na">lockName</span><span class="p">(</span><span class="n">BACKUP_LOCK_NAME</span><span class="p">)</span>
            <span class="p">.</span><span class="na">instanceId</span><span class="p">(</span><span class="n">UUID</span><span class="p">.</span><span class="na">fromString</span><span class="p">(</span><span class="s">&quot;0-0-0-0-0&quot;</span><span class="p">))</span>
            <span class="p">.</span><span class="na">reason</span><span class="p">(</span><span class="s">&quot;Available&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="na">build</span><span class="p">();</span>
</pre></div>
</div>
<p>Thus, we can set the relevant cell to be the serialised value of the backup lock. To be safe, we recommend using a
compare-and-set operation here.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cqlsh:keyspace&gt; CONSISTENCY QUORUM;
cqlsh:keyspace&gt; UPDATE &quot;_persisted_locks&quot; SET value=0x7b226c6f636b4e616d65223a224261636b75704c6f636b222c22696e7374616e63654964223a2230303030303030302d303030302d303030302d303030302d303030303030303030303030222c22726561736f6e223a22417661696c61626c65227d WHERE key=0x4261636b75704c6f636b AND column1=0x6c6f636b AND column2=-1 IF value=0x7b226c6f636b4e616d65223a224261636b75704c6f636b222c22696e7374616e63654964223a2234323765623032612d663031372d343063642d386430382d306131363333313530323961222c22726561736f6e223a22666f6f227d;

 [applied]
-----------
      True
</pre></div>
</div>
<p>Clients should be able to take the backup lock again after this step.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../release_notes/index.html" class="btn btn-neutral float-right" title="Releases" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../miscellaneous/dropwizard-metrics.html" class="btn btn-neutral float-left" title="AtlasDB Metrics" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2017, Palantir Technologies.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>